# SDL3 Binding Checker

This document describes the SDL3 binding checker tool that automatically detects missing or broken function bindings between SDL3 C header files and the corresponding Haskell bindings.

## Overview

The binding checker is a Haskell executable that:

1. **Parses SDL3 C header files** to extract function declarations
2. **Parses Haskell binding files** to extract foreign import declarations
3. **Compares the two** to identify missing bindings
4. **Generates reports** of broken/missing bindings in the `broken/` directory

## Installation & Building

The binding checker is included as an executable in the cabal file. To build it:

```bash
cabal build binding-checker
```

## Usage

### Check All Bindings

To check all SDL3 headers against their corresponding Haskell bindings:

```bash
cabal exec binding-checker
```

### Check Headers via Pipe

To check headers found by `find` or other modern tools:

```bash
find /usr/local/include/SDL3 -name "SDL_*.h" | cabal exec binding-checker
```

This will:
- Find all SDL3 header files in standard locations (`/usr/local/include/SDL3`, `/usr/include/SDL3`, `/opt/homebrew/include/SDL3`)
- Look for corresponding Haskell binding files in `src/SDL/`
- Generate a summary of total broken bindings
- Create individual `.txt` files in `broken/` directory for each header with missing bindings

### Check Single Header

To check a specific header file:

```bash
cabal exec binding-checker /path/to/SDL_header.h
```

### Pipe Examples

#### Traditional Tools
```bash
# Check all SDL3 headers in a directory
find /usr/local/include/SDL3 -name "SDL_*.h" | cabal exec binding-checker

# Check specific headers only
find . -name 'SDL_audio.h' -o -name 'SDL_video.h' | cabal exec binding-checker

# Use with ls
ls /path/to/headers/SDL_*.h | cabal exec binding-checker

# Check headers from a custom build
find ~/custom-sdl3/include -name "*.h" | cabal exec binding-checker
```

#### Modern Tools (Recommended)
```bash
# Interactive header selection with fzf
find /usr/local/include/SDL3 -name "SDL_*.h" | \
  fzf --multi --preview 'head -10 {}' | \
  cabal exec binding-checker

# Fast file discovery with fd
fd 'SDL_.*\.h$' /usr/local/include/SDL3 | cabal exec binding-checker

# Content-aware selection with ripgrep
rg --files-with-matches 'SDL_DECLSPEC.*SDLCALL.*Audio' /usr/local/include/SDL3/ | \
  cabal exec binding-checker

# Smart filtering (exclude test/internal headers)
fd 'SDL_.*\.h$' /usr/local/include/SDL3 | \
  rg -v '(test|internal|revision|copying)' | \
  cabal exec binding-checker

# Find headers with specific function patterns
rg --files-with-matches 'SDL_DECLSPEC.*SDLCALL.*GPU' /usr/local/include/SDL3/ | \
  cabal exec binding-checker
```

#### Tool Installation
```bash
# macOS
brew install fzf ripgrep fd

# Ubuntu/Debian
sudo apt install fzf ripgrep fd-find

# Arch Linux
sudo pacman -S fzf ripgrep fd
```

### Help

```bash
cabal exec binding-checker -- --help
```

### Interactive Workflow Examples

#### Development Workflow with Modern Tools
```bash
# Live preview while selecting headers
rg --files-with-matches 'SDLCALL' /usr/local/include/SDL3/ | \
  fzf --preview 'cabal exec binding-checker {}' \
      --preview-window=right:70% \
      --header 'Live binding check preview'

# Watch for changes during development
watch 'fd SDL_audio.h /usr/local/include/SDL3 | cabal exec binding-checker'

# Check recently modified headers
fd 'SDL_.*\.h$' /usr/local/include/SDL3 --changed-within 7d | \
  cabal exec binding-checker
```

## Output

### Console Output

The tool provides real-time feedback:

```
Checking all SDL3 bindings...
Found 85 SDL3 headers
Checking SDL_camera...
  ✓ All bindings OK
Checking SDL_audio...
  ✗ Found 3 broken bindings
...
Summary: 137 total broken bindings found
Check the 'broken/' directory for details
```

When using piped input:

```
Reading header paths from stdin...
Found 3 SDL3 headers from piped input
Checking SDL_camera...
  ✓ All bindings OK
Checking SDL_audio...
  ✗ Found 3 broken bindings
Checking SDL_video...
  ✓ All bindings OK

Summary: 3 total broken bindings found
Check the 'broken/' directory for details
```

### Broken Bindings Reports

For each header with missing bindings, a report file is created in `broken/SDL_headername.txt`:

```
Broken bindings for SDL_audio
Generated by binding-checker

SDL_PutAudioStreamDataNoCopy SDL_AudioStream *stream const void *buf int len SDL_AudioStreamDataCompleteCallback callback void *userdata
SDL_PutAudioStreamPlanarData SDL_AudioStream *stream const void * const *channel_buffers int num_channels int num_samples
SDL_SetAudioIterationCallbacks SDL_AudioDeviceID devid SDL_AudioIterationCallback start SDL_AudioIterationCallback end void *userdata
```

Each line shows:
- Function name
- C parameter types and names

## How It Works

### Header to Binding File Mapping

The tool maps SDL3 header files to Haskell binding files using these rules:

1. `SDL_headername.h` → `src/SDL/Headername.hsc` or `src/SDL/Headername.hs`
2. Removes `SDL_` prefix and capitalizes the first letter
3. Converts snake_case to CamelCase (e.g., `SDL_test_missing.h` → `TestMissing.hsc`)

### C Function Parsing

The parser extracts functions with this pattern:
```c
extern SDL_DECLSPEC return_type SDLCALL FunctionName(parameters);
```

It handles:
- Different return types (int, const char *, bool, etc.)
- Various parameter lists including void, single params, and multiple params
- Pointer types and const qualifiers

### Haskell Foreign Import Parsing

The parser extracts foreign imports with this pattern:
```haskell
foreign import ccall "C_Function_Name" haskellFunctionName :: Type
```

It handles:
- Single-line foreign imports
- Multi-line foreign imports (function name on next line)
- Mixed whitespace and formatting

### Comparison Logic

The tool compares:
1. C function names extracted from headers
2. C function names referenced in Haskell foreign imports
3. Reports any C functions that don't have corresponding Haskell bindings

## Interpreting Results

### No Broken Bindings

```
✓ All bindings OK
```
All functions in the C header have corresponding Haskell foreign imports.

### Missing Bindings Found

```
✗ Found 3 broken bindings
```
Some C functions are missing Haskell bindings. Check the corresponding file in `broken/` directory.

### No Binding File Found

```
No binding file found for SDL_headername
```
No corresponding Haskell binding file exists for this header. This is expected for:
- Test headers (`SDL_test*`)
- Platform-specific headers (`SDL_egl`, `SDL_vulkan`)
- Internal headers (`SDL_revision`, `SDL_close_code`)

## Limitations

### Expected Differences

Some differences between C headers and Haskell bindings are intentional:

1. **Function Name Changes**: Haskell functions may have different names (e.g., `SDL_GetError` → `sdlGetError`)
2. **Parameter Differences**: Haskell bindings may have simplified or modified parameter types
3. **Excluded Functions**: Some C functions may be intentionally not bound (deprecated, internal, etc.)

### Parser Limitations

1. **Complex Macros**: The parser doesn't handle complex preprocessor macros
2. **Function Pointers**: Complex function pointer declarations may not parse correctly
3. **Comments**: Functions in comments are ignored (as intended)

## Troubleshooting

### Build Issues

If you get regex compilation errors:
```bash
cabal update
cabal install regex-posix
```

### No Headers Found

If no SDL3 headers are found:
```
No SDL3 headers found. Please install SDL3 development files.
```

Install SDL3 development packages:
- **macOS**: `brew install sdl3`
- **Ubuntu**: `sudo apt-get install libsdl3-dev`
- **Manual**: Install from [SDL3 source](https://github.com/libsdl-org/SDL)

### Permission Issues

If you get permission errors accessing header files, make sure SDL3 is properly installed and headers are readable.

## Development

### Adding Test Cases

To test the binding checker:

1. Create a test header file with known functions
2. Create a partial Haskell binding file
3. Run the checker and verify it detects missing bindings

### Extending the Parser

To improve parsing:

1. **C Parser**: Modify `parseCFunction` in `test/binding-checker.hs`
2. **Haskell Parser**: Modify `parseHsFunction` in `test/binding-checker.hs`
3. **File Mapping**: Modify `findBindingFile` for new naming conventions

### Debug Mode

For debugging parser issues, you can modify the code to add debug output or create a separate debug script to test specific parsing cases.

## Integration with CI

The binding checker can be integrated into continuous integration to:

1. **Detect New SDL3 Functions**: Automatically detect when SDL3 adds new functions
2. **Prevent Regressions**: Ensure no existing bindings are accidentally removed
3. **Track Progress**: Monitor binding coverage over time

Example CI usage:
```bash
# In CI script - check all headers
cabal exec binding-checker
if [ $? -eq 0 ]; then
    echo "All bindings up to date"
else
    echo "Missing bindings detected - check broken/ directory"
    exit 1
fi

# Modern approach - content-aware checking
rg --files-with-matches 'SDL_DECLSPEC.*SDLCALL' /usr/include/SDL3/ | \
  cabal exec binding-checker

# Interactive selection in CI
if command -v fzf >/dev/null 2>&1; then
  find /usr/include/SDL3 -name "SDL_*.h" | \
    fzf --multi --header 'Select headers for CI check' | \
    cabal exec binding-checker
else
  find /usr/include/SDL3 -name "SDL_*.h" | cabal exec binding-checker
fi
```

## Modern Tool Integration

The binding checker works excellently with modern CLI tools:

### Recommended Tool Stack
- **fzf**: Interactive fuzzy finder for header selection
- **ripgrep (rg)**: Fast content-aware header filtering
- **fd**: Modern, fast alternative to find
- **bat**: Syntax-highlighted file previews
- **delta**: Better diff output for comparisons

### Advanced Workflows
```bash
# Content-driven selection
rg --files-with-matches 'SDL_DECLSPEC.*(Create|Init|Open)' /usr/local/include/SDL3/ | \
  cabal exec binding-checker

# Multi-stage filtering
fd 'SDL_.*\.h$' /usr/local/include/SDL3 | \
  xargs rg -l 'extern SDL_DECLSPEC' | \
  fzf --preview 'bat --color=always {}' | \
  cabal exec binding-checker

# Git integration
git diff --name-only HEAD~1 | rg 'SDL.*\.h$' | cabal exec binding-checker
```

## Future Improvements

Potential enhancements:

1. **JSON Output**: Machine-readable output for tool integration
2. **Configuration File**: Allow excluding specific functions or headers
3. **Type Checking**: Verify parameter types match between C and Haskell
4. **Documentation Sync**: Check that documentation comments are synchronized
5. **Automated Binding Generation**: Generate skeleton Haskell bindings for missing functions
6. **Version Tracking**: Track which SDL3 version introduced new functions
7. **IDE Integration**: Language server protocol support for real-time checking
